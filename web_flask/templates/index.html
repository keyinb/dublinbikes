<!DOCTYPE html>
<html>
  <head>
    <title>Dublin Bikes</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
  </head>
  <body>
    <header>
      <div id="logo">
        <h1>Dublin Bikes</h1>
      </div>
      <div id="search">
        <button id='search_button'>&#128269;</button>
      </div>
    </header>
    <div id="map"></div>
    <div id="detailed"></div>
    <div id="route">
      <button id='route-close-button' class="close-button">&times;</button>
      <form action="/route" id='route_request' method="POST">
        <label>Start:</label>
        <input type="text" id ='start' name="start">
        <br>
        <label>End:</label>
        <input type="text" id ='end' name="end">
        <br>
        <input type="submit" id="route-submit-button" value="Get Route">
      </form>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      // Shuya - Map function
      var infowindow;

      function initMap(){
        var map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: 53.3498, lng: -6.2603},
            zoom: 13.5,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            language: 'en'
          });

        var data = {{ data | safe }};
        var live_station_data = {{ live_station_data | safe }}

        for (var i = 0; i < data.length; i++){
            var station = data[i];
            var dynamic_data = live_station_data[i];
            var marker = new google.maps.Marker({
              position: {lat: station[0], lng: station[1]},
              map: map
            });

            // Added dynamic station data on load instead of calling the API on every hover. Better performance.
            var infowindow = new google.maps.InfoWindow({
              content: '<h3>' + station[2] + '</h3>' + '<p>Bikes: ' + dynamic_data.available_bikes + ' Stands: ' + dynamic_data.available_bike_stands + '</p>' + "<input style='display: none' value='" + station[3] + "' id='station_num'>"
            });

            marker.addListener('mouseover', (function(marker, infowindow){
              return function() {
                infowindow.open(map, marker);
              }
            })(marker, infowindow));

            marker.addListener('mouseout', (function(marker, infowindow){ 
                return function(){
                  infowindow.close();
                }
              })(marker, infowindow));

            marker.addListener('click', (function(marker, infowindow){
              return function() {
                // George - Extract station number from marker's info window
                var station_num = $('#station_num').val();

                // George - Use AJAX to submit a POST request to server for associated server information
                $.ajax({
                    type: "POST",
                    url: "/detailed",
                    data: { station_num },
                    success: function(response) {
                      $("#detailed").html(response); // update the detailed div with response
                      $("#detailed").addClass('show'); // fade in the detailed div
                      if($('#route').hasClass('show')){
                        $("#route").removeClass('show'); // remove the 'show' class to hide the route div if open
                      }
                    }
                  });
                }
              })(marker, infowindow));            
            }

        // Cian - Route Function
        // Use AJAX to catch route form submission and then update the map with the response.
        $(document).ready(function(){
              $('#route_request').submit(function(event){
                event.preventDefault();
                var formData = {
                  start: $('#start').val(),
                  end: $('#end').val()
                }
                $.ajax({
                  type: "POST",
                  url: '/route',
                  data: formData ,
                  success: function(response){
                    console.log('Returned route received:', response)
                    var start_lat = response.start_lat
                    var start_lng = response.start_lng
                    var end_lat = response.end_lat
                    var end_lng = response.end_lng

                    //create the start and end points
                    var start = new google.maps.LatLng(start_lat, start_lng);
                    var end = new google.maps.LatLng(end_lat, end_lng);
                    //create the directions service which gets the route.
                    var directionsService = new google.maps.DirectionsService();
                    directionsService.route({
                      origin: start,
                      destination: end,
                      travelMode: 'BICYCLING'//as we are making a bike application
                    }, function(response, status) {
                      if (status === 'OK') {
                        console.log('Status is "OK": mapping route.')
                        //display the route on the map
                        var directionsDisplay = new google.maps.DirectionsRenderer({
                          map: map,
                          //make the line red because it is cooler than blue
                          polylineOptions: {
                          strokeColor: "red",
                          strokeOpacity: 0.7,
                          strokeWeight: 4
                          },
                          suppressMarkers: true // suppress default markers
                        });
                        directionsDisplay.setDirections(response);
                        //read out the duration of the route
                        var route = response.routes[0];
                        var duration = route.legs[0].duration.text;
                        //display this info
                        var infowindow = new google.maps.InfoWindow({
                          content: duration
                        });
                        //creating the end marker to display the trip duration
                        var marker_end = new google.maps.Marker({
                          position: end,
                          map: map,
                          title: duration
                        });
                        //creating the start marker
                        var marker_start = new google.maps.Marker({
                          position: start,
                          map: map,
                          title: null
                        });
                        //when you click the end marker you see the travel time
                        marker_end.addListener('click', function() {
                        infowindow.open(map, marker_end);
                        });

                      } else {
                        console.log('Directions request failed due to ' + status);
                      }
                    });

                  }
                })
              })
            })
      }
  
      // George - Open and close side display
      $(document).on('click', '#close-button', function(){
                $("#detailed").removeClass('show'); // remove the 'show' class to hide the detailed div
            
            });
      
      $(document).on('click', '#search_button', function(){
          $("#route").addClass('show'); // add the 'show' class to display the route div
          if($('#detailed').hasClass('show')){
            $("#detailed").removeClass('show'); // remove the 'show' class to hide the detailed div if open
          }
          
      });

      $(document).on('click', '#route-close-button', function(){
                $("#route").removeClass('show'); // remove the 'show' class to hide the route div
            });
      
    </script>
    <!-- Googlemap API --> 
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC3NV_XtqrUxY3YWqZfs1W7pL8EMM4xeoY&language=en&callback=initMap"></script>
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <title>Dublin Bikes</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
  </head>
  <body>
    <header>
      
      <div id="logo">
        <h1>Dublin Bikes</h1>
      </div>
      <div id="predictions">
          <button id='plan_journey_button'>Plan Journey</button>
          <div id="pred_content">
            <!--Button for Date-->
            <button class="datebtn">Enter the Date of your Journey:</button>
            <select id="dateDropdown">
              <!-- Placeholder -->
              <option value="" disabled selected>Select a date</option>
            </select>
            <!--Button for Time-->
            <button class="timebtn">Enter the Time of your Journey (Hour):</button>
            <select id="timeDropdown">
              <!-- Placeholder -->
              <option value="" disabled selected>Select a time (hour)</option>
            </select>
            <!--Button for Station-->
            <button class="timebtn">Enter the Station you need for your Journey:</button>
            <select id="stationDropdown">
              <!-- Placeholder -->
              <option value="" disabled selected>Select a station</option>
            </select>
            <button id='predict_button'>Predict</button>
          </div>
      </div>
      <div id="header-right">
        <div id="search">
          <button id='search_button'>Route Finder &#128269;</button>
        </div>
        <div id="for_circle">
          <input type="checkbox" id="check_box" name="check_box">
          <label for="check_box">Markers (ðŸŸ¢ðŸŸ ðŸ”´)</label> 
        </div> 
      </div>
    </header>
    <div class="scroll-container">
      <div id='current-weather' class="scroll-content"></div>
    </div>
    <div id="map"></div>
    <div id="detailed">
    </div>
    <div id="route">
      <button id='route-close-button' class="close-button">&times;</button>
      <form action="/route" id='route_request' method="POST">
        <label>Start:</label>
        <input type="text" id ='start' name="start">
        <br>
        <label>End:</label>
        <input type="text" id ='end' name="end">
        <br>
        <input type="submit" id="route-submit-button" value="Get Route">
      </form>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      var circles = [];
      // Map function
      //initialise the map to  Dublin and load as a roadmap
      function initMap(){
        var map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: 53.3498, lng: -6.2603},
            zoom: 13.5,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            language: 'en'
          });

        var data = {{ data | safe }};
        var live_station_data = {{ live_station_data | safe }}
        var user_location;

        // Locate user and display on map
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };

            var userMarker = new google.maps.Marker({
              position: userLocation,
              map: map,
              title: "You are here",
              icon: {
                url: "http://maps.google.com/mapfiles/ms/icons/red.png"
                
              }
            });
      
            map.setCenter(userLocation);
          });
        }

        // Route Function
        // Use AJAX to catch route form submission and then update the map with the response.
        $(document).ready(function(){
          $('#route_request').submit(function(event){
            //prevent the form from submitting until the data is added
            event.preventDefault();
            var formData = {
              //adding ', Dublin' to the end of the input address to ensure that the geocoder returns the correct location
              start: $('#start').val()+', Dublin',
              end: $('#end').val()+', Dublin'
            }
            $.ajax({
              type: "POST",
              url: '/route',
              data: formData ,
              success: function(response){
                console.log('Returned route received:', response)
                var start_lat = response.start_lat
                var start_lng = response.start_lng
                var end_lat = response.end_lat
                var end_lng = response.end_lng

                //create the start and end points
                var start = new google.maps.LatLng(start_lat, start_lng);
                var end = new google.maps.LatLng(end_lat, end_lng);
                //create the places service to confine the search to within xkm of the centre of dublin

              //create the directions service which gets the route.
              var directionsService = new google.maps.DirectionsService();
              directionsService.route({
                origin: start,
                destination: end,
                travelMode: 'BICYCLING'//as we are making a bike application
              }, function(response, status) {
                if (status === 'OK') {
                  console.log('Status for directions service is "OK": mapping route.')
                  //display the route on the map
                  var directionsDisplay = new google.maps.DirectionsRenderer({
                    map: map,
                    //make the line red because it is cooler than blue
                    polylineOptions: {
                    strokeColor: "red",
                    strokeOpacity: 0.7,
                    strokeWeight: 4
                    },
                    suppressMarkers: true // suppress default markers
                  });
                  directionsDisplay.setDirections(response);
                  //read out the duration of the route
                  var route = response.routes[0];
                  var duration = route.legs[0].duration.text;
                  //display this info
                  var infowindow = new google.maps.InfoWindow({
                    content: duration
                  });
                  //creating the end marker to display the trip duration
                  var marker_end = new google.maps.Marker({
                    position: end,
                    map: map,
                    title: duration
                  });
                  //creating the start marker
                  var marker_start = new google.maps.Marker({
                    position: start,
                    map: map,
                    title: null
                  });
                  //when you click the end marker you see the travel time
                  marker_end.addListener('click', function() {
                  infowindow.open(map, marker_end);
                  });
            
                } else {
                  console.log('Directions request failed due to ' + status);
                }
                });

              }
            })
          })
        })

        
        // Generate markers
        for (var i = 0; i < data.length; i++){
          var station = data[i];
          var dynamic_data = live_station_data[i];
        
          var marker = new google.maps.Marker({
            position: {lat: station[0], lng: station[1]},
            map: map
          });

          var bikeavailability = dynamic_data.available_bikes;
          var bikestandsavailability = dynamic_data.available_bike_stands;
          var circleRadius = 100;
          
        
          var circle = new google.maps.Circle({
            strokeOpacity: 0.8,
            strokeWeight: 2,
            strokeColor: '#FF0000',
            fillColor: '#FF0000',
            fillOpacity: 0.35,
            map: map,
            center: {lat: station[0], lng: station[1]},
            radius: circleRadius,

            
          });
          
          circle.setVisible(false);
          
          if (bikeavailability > 10) {
            circle.setOptions({
              fillColor: '#00FF00',
              strokeColor: '#00FF00'
            });
          } else if (0 < bikeavailability && bikeavailability <= 10) { 
            circle.setOptions({
              fillColor: '#FFFF00',
              strokeColor: '#FFFF00'
            });
          } else if (bikeavailability == 0) {
            circle.setOptions({
              fillColor: '#FF0000',
              strokeColor: '#FF0000'
            });
          } 
          
          if (bikestandsavailability == 0) {
            circle.setOptions({
              radius: circleRadius * 0.5
            });
          } 
          
          else if (10 < bikestandsavailability) { 
            circle.setOptions({
              radius: circleRadius * 2
            });
          } else if (0 < bikestandsavailability && bikestandsavailability <= 10) { 
            circle.setOptions({
              radius: circleRadius * 1
            });
          } 
          
          circles.push(circle);

          // Added dynamic station data on load instead of calling the API on every hover. Better performance.
          var infowindow = new google.maps.InfoWindow({
            content: '<h3>' + station[2] + '</h3>' + '<p>Bikes Available: ' + dynamic_data.available_bikes +
              ' Empty Stands: ' + dynamic_data.available_bike_stands + '</p>' + "<input style='display: none' value='" +
                station[3] + "' id='station_num'>"
          });
          //open the info window when we hover over the marker
          marker.addListener('mouseover', (function(marker, infowindow){
            return function() {
              infowindow.open(map, marker);
            }
          })(marker, infowindow));
          //close the infowindow when we move off the marker
          marker.addListener('mouseout', (function(marker, infowindow){ 
              return function(){
                infowindow.close();
              }
            })(marker, infowindow));

          marker.addListener('click', (function(marker, infowindow){
            return function() {
              // George - Extract station number from marker's info window
              var station_num = $('#station_num').val();

              // George - Use AJAX to submit a POST request to server for associated server information
              $.ajax({
                  type: "POST",
                  url: "/detailed",
                  data: { station_num },
                  success: function(response) {
                    $("#detailed").html(response); // update the detailed div with response
                    $("#detailed").addClass('show'); // fade in the detailed div
                    generateAvailabilityChart(averageData); 
                    generateOccupancyChart(averageData);
                    if($('#route').hasClass('show')){
                      $("#route").removeClass('show'); // remove the 'show' class to hide the route div if open
                    }

                  }
                });
              }
            })(marker, infowindow));            
        }
        

      }

      function toggleCircles(){
        for (var i = 0; i < circles.length; i++) {
          var circle = circles[i];
          if (circle.getVisible()) {
            circle.setVisible(false); 
          } else {
            circle.setVisible(true); 
          }
        }
      }

      var check = document.getElementById('check_box');
      check.addEventListener('click', toggleCircles);

  
      // George - Open and close side display
      $(document).on('click', '#close-button', function(){
                $("#detailed").removeClass('show'); // remove the 'show' class to hide the detailed div
            
            });
      
      $(document).on('click', '#search_button', function(){
          $("#route").addClass('show'); // add the 'show' class to display the route div
          if($('#detailed').hasClass('show')){
            $("#detailed").removeClass('show'); // remove the 'show' class to hide the detailed div if open
          }
          
      });

      $(document).on('click', '#route-close-button', function(){
                $("#route").removeClass('show'); // remove the 'show' class to hide the route div
            });

      // George Current Weather Function
      var current_weather = {{ current_weather | safe }};

      function convertTime(time){
        const date = new Date(time * 1000);
        // Get hours, minutes, and seconds
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        // Format the time
        const readableTime = `${hours}:${minutes}`;
        return readableTime;
      }

      function currentWeather(current_weather){
        var today = `Today: <img src='/static/assets/weather_icons/${current_weather.current.weather[0].icon}.png' id='weather-icon'>`
        var temp = `Temp: ${current_weather.current.temp}Â°C`;
        var feels_like = `Feels Like: ${current_weather.current.feels_like}Â°C`
        var pressure = `Pressure: ${current_weather.current.pressure}Pa`
        var humidity = `Humidity: ${current_weather.current.humidity}`
        var sunrise = `Sunrise: ${convertTime(current_weather.current.sunrise)}`
        var sunset =`Sunset: ${convertTime(current_weather.current.sunset)}`
        var weather = `<div class='weather-item'>${pressure}</div>
                      <div class='weather-item'>${humidity}</div>
                      <div class='weather-item'>${sunrise}</div>
                      <div class='weather-item'>${sunset}</div>
                      <div class='weather-item'>${feels_like}</div>
                      <div class='weather-item'>${temp}</div>
                      <div class='weather-item'>${today}</div>`
        $('#current-weather').html(weather);
        console.log(today)
      }
      
      // George Historical Chart Functions
      function generateAvailabilityChart(data) {
        const ctx = document.getElementById('availabilityChart').getContext('2d');
        const labels = Object.keys(data);
        const dataset = labels.map(hour => data[hour]['Avg A']);
        const currentDay = getDay();

        availabilityBikeChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: `Average Available Bikes per Hour (${currentDay})`,
                    data: dataset,
                    backgroundColor: 'rgba(20, 64, 105)',
                    borderColor: 'rgba(20, 64, 105)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
      }

      function getDay(){
        const today = new Date();
        const options = { weekday: 'long' };
        return today.toLocaleDateString(undefined, options);
      }

      function generateOccupancyChart(data) {
        const ctx = document.getElementById('occupancyChart').getContext('2d');
        const labels = Object.keys(data);
        const dataset = labels.map(hour => data[hour]['Avg O']);
        const currentDay = getDay();

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: `Average Available Stands per Hour (${currentDay})`,
                    data: dataset,
                    backgroundColor: 'rgba(20, 64, 105)',
                    borderColor: 'rgba(20, 64, 105)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
      }

      currentWeather(current_weather);

      //Cian user interaction with date and time pickers
      //when the plan journey button is clicked display a menu with the following dropwdowns
      //station, date and time
      $(document).on('click', '#plan_journey_button', function(){
        $("#pred_content").toggleClass('show');
      });


      //when the user selects enter for those values call the generatePredictions function
      // next steps:
      //create 3 dropdown menus for user to enter station, date and time
      // Get the current date
      var currentDate = new Date();
      // Loop through the next 5 days and generate options for each date
      //is this range correct?
      for (var i = 2; i < 7; i++) {
        // Create a new date object for the current date + i days
        var date = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate() + i);
        // Format the date as YYYY-MM-DD
        var formattedDate = date.toISOString().slice(0, 10);
        // Create a new option element for the date and add it to the dropdown menu
        var option = document.createElement("option");
        option.text = formattedDate;
        option.value = formattedDate;
        dateDropdown.add(option);
      }

      var dateDropwdown = $("#dateDropdown").val();
      var timeDropdown = document.getElementById("timeDropdown");

      for (var i=0;i<=7;i++){
        //weather forecast is every 3 hours
        var time=i*3;
        var option = document.createElement("option");
        var timeString = time.toString().padStart(2, "0") + ":00:00";
        option.text = timeString;
        option.value = timeString;
        timeDropdown.add(option);
      }
      //finally the station dropdown menu
      var stationDropdown = document.getElementById("stationDropdown");
      //get the station names from the station data
      var station_data= {{ live_station_data | safe }};
      //get the station numbers
      //loop through the station names and add them to the dropdown menu
      for (var i=0;i<station_data.length;i++){
        var option = document.createElement("option");
        var stat=station_data[i]
        var stationNum = stat.number;
        var stationName=stat.name;
        option.text = stationName+' '+stationNum;
        option.value = stationNum;
        stationDropdown.add(option);
      }
      
      //call the generate predictions function when subit button is clicked
      $(document).on('click', '#predict_button', function(){
        //call the generate predictions function
        X_test=generatePredictions()
        console.log(X_test)
      });
      
//Left to do:
// fix the weather call to get the correct weather information
// send the X_test data to the correct prediction model
// do this in app.route predict
//return the availability percentage here
//process this and graph it
//the time is from the next 5 days starting right now


      function generatePredictions(){
        //make these drop down menus
        var user_pred_station=stationDropdown.value;
        // drop down of next 5 days
        var user_pred_date = dateDropdown.value;
        //drop down from hours 0,3,6,9,12,15,18,21
        var user_pred_time = timeDropdown.value;
        //this value can be used for getting the correct weather data
        var merge_pred_date_time = user_pred_date + ' ' + user_pred_time

        //Cian - weather forecast function
        var forecast_weather= {{ forecast_weather | safe }};
        //conole.log(forecast_weather.list)
        function forecastWeather(forecast_weather){
          //find the correct weather data for the date and time the user has selected
          for (var i=0; i<forecast_weather.list.length; i++){
            console.log(forecast_weather.list[i].dt_txt)
            console.log(merge_pred_date_time)
            var dateStr = forecast_weather.list[i].dt_txt
            if( dateStr == merge_pred_date_time){
              //extract temperature, wind speed and rain
             
              var f_temp = forecast_weather.list[i].main.temp;
              var f_wind_speed = forecast_weather.list[i].wind.speed
              // check is rain is present, if it is then extract rain val,
              //if not then set to 0 instead of null
              var f_rain = forecast_weather.list[i].rain ? forecast_weather.list[i].rain["3h"] : 0;
              return [f_temp, f_wind_speed, f_rain];
            }
          }
          return null; //if no data obtained
        }

        var [pred_temp, pred_wind_speed, pred_rain] = forecastWeather(forecast_weather);
 
        //convert the hour to integer format
        var user_pred_time_int = parseInt(user_pred_time)
        //extract the future day of the week from the date
        const date = new Date(user_pred_date);
        const day = date.getDay(); // returns a number between 0 (Sunday) and 6 (Saturday)
        //insert a 1 in the column corresponding to the day of the week
        var user_pred_day_col=day+4
        //set all days to zero initially
        var X_test= [[pred_temp,pred_wind_speed,pred_rain,user_pred_time_int,0,0,0,0,0,0,0]]
        X_test.forEach((column) => {
          column[user_pred_day_col] = 1;
        });
        return X_test
      }

    </script>
    <!-- Googlemap API --> 
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC3NV_XtqrUxY3YWqZfs1W7pL8EMM4xeoY&language=en&callback=initMap&libraries=places"></script>
    <!-- jQuery Date picker -->
  </body>
</html>
